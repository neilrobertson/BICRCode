#!/usr/bin/env python

import sys
import httplib, urllib, requests
import json


##curl -H "Content-Type: application/json" -X POST -d '{"query":"TP53"}' http://genomecrispr.dkfz.de/api/sgrnas/symbol
target_url = "http://genomecrispr.dkfz.de/api/sgrnas/symbol"
gene_list_file = "/mnt/bam01/projects/Peter/CRISPR_EpigeneticLibrary/Chromatin_Genes_27_01_2015_PeterAdams.txt"
output_filename = "/mnt/bam01/projects/Peter/CRISPR_EpigeneticLibrary/DKFZ/EpiCRISPR.DFKZ.Hits.csv"

output_header = ["guide_name", "symbol", "ensemble_id", "sequence", "chr", "start", "stop", "is_hit", "cell_line", "effect", "screentype"]
output_lines = []


print "Building gene list from manifest..."
gene_list = []
with open(gene_list_file, "r") as gene_file:
	for line in gene_file:
		gene_list.append(line.strip().split("\t")[0])


#gene_list = ["TP53", "EZH2"]
print "Beginning to contact {0} for each gene...".format(target_url)
gene_status = []
for gene_name in gene_list:

	headers = {"Content-Type":"application/json"}
	payload = "{\"query\":\"%s\"}" % (gene_name)

	r = requests.post(target_url, headers = headers, data = payload)

	status = r.status_code
	response_json = json.loads(r.text)

	if status != 200:
		failed_genes.append(gene_name)

	print "Gene: %s StatusCode: %s gRNA Entities: %s" % (gene_name, str(status), str(len(response_json)))
	total_hits = 0
	for i, entity in enumerate(response_json):
		symbol = entity["symbol"]
		sequence = entity["sequence"]
		fold_change = entity["log2fc"]
		cellline = entity["cellline"]
		ensemble_id = entity["ensg"]
		cas = entity["cas"]
		is_hit = entity["hit"]
		chrm = entity["chr"]
		start = entity["start"]
		stop = entity["end"]
		screentype = entity["screentype"]
		guide_name = entity["name"]
		#score = entity["score"]
		effect = entity["effect"]

		if is_hit == "true":
			output_lines.append([guide_name, str(symbol), str(ensemble_id), str(sequence), chrm, str(start), str(stop), str(is_hit), str(cellline), str(effect), str(screentype)])
			total_hits = total_hits + 1
	print "Total hits: %s" % (str(total_hits))

	gene_status.append([gene_name, str(status), str(len(response_json)), str(total_hits)])

for item in gene_status:
	print "\t".join(item)


with open(output_filename, "w") as output_file:

	output_file.write("\t".join(output_header) + "\n")
	for line in output_lines:
		output_file.write("\t".join(line) + "\n")


'''
BAF53A	200	0	0
ACTL6	200	0	0
ALKBH2	200	768	24
DEPC-1	200	0	0
AOF2	200	0	0
ARID1A	200	807	113
ARID1B	200	607	0
ARID3A	200	801	4
ARID3B	200	649	0
ARID4A	200	750	0
ARID4B	200	1084	26
ARID5A	200	792	0
ARID5B	200	828	0
ASF1A	200	2067	28
ASF1B	200	810	0
ASH1L	200	835	0
ASH2L	200	800	227
ASXL1	200	804	0
ASXL2	200	656	54
ASXL3	200	793	37
ATAD2	200	810	36
ATF2	200	798	0
ATM	200	778	26
ATR	200	804	309
ATRX	200	806	89
AURKB	200	807	354
BAZ1A	200	711	20
BAZ1B	200	814	118
BAZ2A	200	788	10
BAZ2B	200	784	0
BMI1	200	628	13
BOP1	200	730	178
FALZ	200	0	0
BRAF	200	834	52
BRD1	200	808	15
BRD2	200	1085	226
BRD3	200	798	0
BRD4	200	810	231
BRD7	200	1876	10
BRD8	200	802	173
BRD9	200	863	52
BRDT	200	765	14
BRPF1	200	802	41
C21ORF107	200	0	0
BTAF1	200	790	224
GAS	200	0	0
CARM1	200	798	66
CBX1	200	547	0
CBX3	200	531	0
CBX4	200	790	18
CBX5	200	696	3
CBX6	200	784	0
CBX7	200	547	4
CBX8	200	805	14
CDY1	200	733	56
CDY1B	200	510	56
CDY2	200	0	0
CDYL	200	839	0
CDYL2	200	797	0
CEBPB	200	760	27
CENPA	200	1095	400
FLJ13111	200	0	0
CHAF1A	200	759	247
CHAF1B	200	715	246
CHD1	200	780	165
CHD1L	200	281	0
CHD2	200	792	0
CHD3	200	701	0
CHD4	200	789	333
CHD5	200	809	10
CHD6	200	797	4
CHD7	200	806	10
CHD8	200	823	63
CHD9	200	749	0
BC-2	200	0	0
C14ORF123	200	0	0
C20ORF178	200	0	0
C9ORF83	200	0	0
FLJ11749	200	0	0
CHRAC1	200	744	16
MHC2TA	200	0	0
CITED1	200	785	0
CITED2	200	727	37
CITED4	200	675	0
CLOCK	200	713	0
CNOT2	200	702	122
COMMD1	200	627	15
CSN2	200	575	4
CREB1	200	831	66
CREBBP	200	789	88
CSDA	200	0	0
CSE1L	200	713	266
CTCF	200	838	302
CTNNB1	200	806	151
CTSL	200	824	10
CUL4A	200	766	10
CUL4B	200	713	0
CUTL1	200	0	0
CXXC1	200	799	114
CYP27B1	200	689	0
CYP2B6	200	531	0
CYP3A4	200	555	20
DACH1	200	802	0
DAPK3	200	726	0
DAXX	200	907	189
DDB1	200	706	245
DDX1	200	706	195
DEK	200	711	30
DFFA	200	552	0
DFFB	200	701	0
DICER1	200	814	127
DATF1	200	0	0
DLX2	200	817	48
DMAP1	200	808	356
DMPK	200	455	0
DNMT1	200	815	250
DNMT3B	200	794	6
DNMT3L	200	755	9
DOK4	200	691	0
DOT1L	200	718	64
E2F1	200	783	0
E2F3	200	780	77
E2F4	200	794	0
EDF1	200	705	24
EED	200	777	85
EHMT1	200	637	76
EHMT2	200	1101	16
EIF2S3	200	520	132
ELP3	200	814	315
EP300	200	823	72
EP400	200	798	65
ERCC6	200	223	0
FLJ20105	200	0	0
ESR2	200	906	0
EVI1	200	0	0
EZH1	200	802	0
EZH2	200	806	30
FABP1	200	634	0
TNFSF6	200	0	0
FBXL10	200	0	0
FBXL11	200	0	0
FBXL19	200	679	36
FBXW7	200	897	58
FFAR1	200	645	6
FKBP1A	200	507	0
FKBP2	200	694	38
FKBP5	200	728	0
FOS	200	796	0
FOXA1	200	809	30
FOXA2	200	800	27
FOXA3	200	773	25
FOXI1	200	694	6
FOXL2	200	768	3
FOXO1A	200	0	0
FOXP3	200	791	0
FRAP1	200	0	0
FRDA	200	0	0
GABRB3	200	721	0
GAS2L1	200	437	0
GATA1	200	790	17
GATA2	200	783	44
GATA3	200	794	0
GATA6	200	745	53
GCN5L2	200	0	0
GMNN	200	603	44
GSN	200	697	0
GTF2I	200	58	0
GTF3C4	200	841	237
H1F0	200	664	0
H2AFJ	200	611	0
H2AFV	200	613	0
H2AFY	200	1058	0
H2AFY2	200	580	0
H2AFZ	200	444	55
H3F3A	200	205	6
H3F3B	200	542	18
HAT1	200	780	0
HBB	200	533	0
HBG1	200	0	0
HCFC1	200	811	345
HDAC1	200	812	41
HDAC10	200	0	0
HDAC11	200	825	0
HDAC2	200	655	16
HDAC3	200	806	361
HDAC4	200	816	0
HDAC5	200	701	0
HDAC6	200	797	4
HDAC7A	200	0	0
HDAC7A	200	0	0
HDAC8	200	768	32
HDAC9	200	847	0
HELLS	200	634	20
HIRA	200	0	0
HIRIP3	200	418	0
HIST1H1C	200	740	34
HIST1H1E	200	718	36
HIST1H2BJ	200	523	30
HIST1H2BO	200	617	0
HIST1H3E	200	527	10
HIST2H2AA	200	0	0
HIST2H2BE	200	534	66
HIST2H3A	200	495	82
HIST2H4	200	0	0
HIST3H3	200	642	0
SMARCA3	200	0	0
HMG20A	200	797	14
HMG20B	200	796	11
HMGA1	200	530	26
HMGA2	200	823	6
HMGB1	200	384	39
HMGB2	200	721	0
HMGB3	200	416	0
HMGN1	200	592	0
HMGN2	200	415	2
HMGN3	200	633	10
HMGN4	200	529	14
MGC26710	200	0	0
HTATIP	200	0	0
ID3	200	683	16
IFNG	200	527	0
ZNFN1A3	200	0	0
IL12A	200	683	5
IL15	200	553	16
IL1B	200	679	0
IL2	200	565	9
ING1	200	890	36
ING1L	200	0	0
ING4	200	798	0
INOC1	200	0	0
INOC1	200	0	0
IRF3	200	752	0
JARID1A	200	0	0
JARID1B	200	0	0
JARID1C	200	0	0
JARID1D	200	0	0
JARID2	200	824	0
KIAA1718	200	0	0
JMJD1A	200	0	0
JMJD1B	200	0	0
JMJD1C	200	794	5
JMJD2A	200	0	0
JMJD2C	200	0	0
JMJD2D	200	0	0
JMJD4	200	788	6
JMJD5	200	0	0
PTDSR	200	0	0
JUN	200	796	45
JUNB	200	737	75
JUND	200	788	20
GCN5L2	200	0	0
PCAF	200	0	0
HTATIP	200	0	0
KIF22	200	709	105
KLK3	200	695	24
MGC20419	200	0	0
L3MBTL	200	0	0
L3MBTL2	200	361	0
LALBA	200	613	4
LBR	200	806	0
LMNB1	200	704	50
LMNB2	200	712	3
LOC375748	200	0	0
MAD2L1	200	535	86
MAD2L2	200	707	199
MAF	200	766	0
MAFG	200	222	0
MAFK	200	727	32
MAOB	200	667	4
MBD1	200	787	10
MBD2	200	781	47
MBD3	200	0	0
MBD3L1	200	720	2
MBD3L2	200	548	24
MBD4	200	840	0
MBD5	200	842	0
MBD6	200	780	13
MCM10	200	684	113
MCM2	200	805	228
MDM2	200	815	149
MDS1	200	0	0
MECP2	200	718	0
MEN1	200	805	85
FLJ13984	200	0	0
MFAP1	200	671	264
MGMT	200	708	3
MLL	200	0	0
MLL2	200	0	0
MLL3	200	0	0
MMP9	200	742	0
MORF4L1	200	823	18
MORF4L2	200	642	0
MPO	200	694	0
MSH6	200	189	0
MSL3L1	200	0	0
MTA1	200	767	24
MTA2	200	793	65
MTA3	200	723	7
MYBL2	200	804	178
MYC	200	674	272
MYCN	200	810	6
MYO1C	200	721	0
MYST1	200	0	0
MYST2	200	0	0
MYST3	200	0	0
MYST4	200	0	0
NAP1L1	200	545	3
NAP1L2	200	585	10
NAP1L3	200	664	20
NAP1L4	200	725	0
NAP1L5	200	646	0
NASP	200	604	40
CNAP1	200	0	0
CAPG	200	725	0
NCOA1	200	821	0
NCOA3	200	787	9
NFE2	200	794	10
NFKB1	200	804	0
NPM1	200	447	37
NPM3	200	690	78
NR0B2	200	824	0
NR1H4	200	778	0
NR1I3	200	780	0
NR3C1	200	802	0
NSBP1	200	0	0
NSD1	200	848	10
NUP62	200	500	161
OIP5	200	700	217
ORC1L	200	0	0
ORC2L	200	0	0
PADI4	200	549	0
PAK1	200	690	0
FLJ21816	200	0	0
PAM	200	696	0
PARP1	200	783	29
PARP2	200	607	17
ZNF278	200	0	0
PAX5	200	641	18
PAXIP1L	200	0	0
PB1	200	0	0
PCAF	200	0	0
PCGF1	200	772	8
PCGF2	200	824	3
PCGF3	200	654	0
PCGF5	200	698	3
PCGF6	200	800	2
PCMT1	200	596	0
PCNA	200	771	312
PHC1	200	595	2
PHC2	200	891	10
PHC3	200	801	0
PHF1	200	848	0
PHF2	200	830	4
PHF21A	200	792	0
PHF5A	200	506	114
PHF8	200	825	49
PI3	200	562	12
PIM1	200	781	21
PIN1	200	695	21
PJA2	200	687	0
PLK1	200	693	268
POLE3	200	194	6
POLR2B	200	761	265
POU2F1	200	796	48
PPARGC1A	200	832	6
PRDM1	200	824	5
PRDM10	200	827	65
PRDM11	200	642	0
PRDM12	200	791	0
PRDM13	200	773	13
PRDM14	200	791	0
PRDM15	200	773	10
PRDM16	200	925	18
PRDM2	200	877	0
PRDM4	200	15	0
PRDM5	200	792	0
PRDM6	200	543	0
PRDM8	200	807	46
PRDM9	200	645	0
PRKAA1	200	771	30
PRKAA2	200	813	6
PRKCD	200	833	0
HRMT1L2	200	0	0
HRMT1L1	200	0	0
HRMT1L3	200	0	0
SKB1	200	0	0
HRMT1L6	200	0	0
PRMT7	200	809	68
HRMT1L3	200	0	0
PSIP1	200	567	15
C10ORF89	200	0	0
PTMA	200	618	2
ASC	200	0	0
RAD21	200	597	110
RAD54B	200	448	6
RAD54L	200	546	19
SRISNF2L	200	0	0
RARA	200	567	18
RARB	200	828	10
RB1	200	770	38
RBBP4	200	666	188
RBBP5	200	800	308
RBBP7	200	804	52
RBL1	200	533	2
RCBTB1	200	678	3
RCOR1	200	790	45
RET	200	825	30
REXO1	200	590	50
RING1	200	999	69
RNF2	200	759	0
RNF20	200	791	345
RNF40	200	804	200
RPA1	200	710	275
HBXAP	200	0	0
RUVBL1	200	908	378
SAFB	200	797	133
SATB1	200	827	0
SCMH1	200	811	0
SET	200	602	0
SETD1A	200	794	290
HYPB	200	0	0
C14ORF154	200	0	0
C21ORF18	200	0	0
SET7	200	0	0
SET8	200	0	0
SETDB1	200	708	120
SETDB2	200	785	0
SETMAR	200	819	6
SFMBT1	200	733	0
SFMBT2	200	805	0
SIN3A	200	819	213
SIN3B	200	686	9
SIRT1	200	805	0
SIRT2	200	797	0
SIRT3	200	795	0
SIRT4	200	775	0
SIRT5	200	819	0
SIRT6	200	784	0
SIRT7	200	794	11
SLBP	200	690	39
SMAD4	200	789	42
SMARCA1	200	791	10
SMARCA2	200	809	3
SMARCA4	200	775	62
SMARCA5	200	596	167
SMARCAD1	200	807	4
SMARCAL1	200	801	10
SMARCB1	200	834	277
SMARCC1	200	824	33
SMARCC2	200	799	0
SMARCD1	200	801	92
SMARCD2	200	795	31
SMARCD3	200	825	0
SMARCE1	200	0	0
SMC1L1	200	0	0
SMC1L2	200	0	0
SMC2L1	200	0	0
CSPG6	200	0	0
SMC4L1	200	0	0
SMC5L1	200	0	0
SMC6L1	200	0	0
SMUG1	200	697	3
SMYD1	200	839	0
SMYD2	200	775	0
SMYD3	200	834	0
SMYD4	200	792	2
SMYD5	200	792	0
SNAI1	200	751	2
SND1	200	796	12
SKIIP	200	0	0
SOX10	200	802	24
SOX12	200	756	20
SOX2	200	788	44
SOX6	200	838	0
SOX9	200	802	123
SP3	200	761	36
SRCAP	200	257	28
SSH2	200	633	0
SSRP1	200	800	315
STAT3	200	806	0
STAT6	200	824	0
STK11	200	842	157
STK4	200	827	0
PC4	200	0	0
SDS3	200	0	0
SUPT16H	200	788	278
SUPT4H1	200	596	88
SUPT5H	200	723	253
SUV39H1	200	98	0
SUV39H2	200	402	0
SUV420H1	200	787	60
SUV420H2	200	799	21
JJAZ1	200	0	0
TADA2L	200	0	0
TADA3L	200	0	0
TAF1	200	840	204
TAPBP	200	861	0
TBL1XR1	200	503	49
TCEA1	200	488	23
TCF7L1	200	793	0
TCF7L2	200	345	72
TFF1	200	665	3
TGM1	200	675	0
TGM2	200	784	0
TIMELESS	200	699	211
FLJ20516	200	0	0
TLK2	200	450	47
TMPO	200	695	0
TNF	200	917	0
TNP1	200	558	3
TOP1	200	484	111
TOX	200	701	0
C14ORF92	200	0	0
TP53	200	788	58
TP53BP1	200	822	12
TPM1	200	648	24
DNMT2	200	0	0
TIF1	200	0	0
TRIM28	200	804	198
TRIM33	200	817	61
TSPYL2	200	692	16
TSPYL4	200	687	0
TSPYL5	200	661	8
SSTK	200	0	0
TTF2	200	697	144
TTK	200	687	187
UBA52	200	4	4
UBE2A	200	691	20
UBE2B	200	667	4
UBE2E1	200	844	24
UBE2I	200	321	104
USF1	200	788	7
USP16	200	672	0
USP22	200	709	10
USP27X	200	550	10
USP51	200	617	0
SAS10	200	0	0
UTX	200	0	0
UXT	200	566	137
VAX2	200	813	10
VIM	200	646	0
CFL1	200	2	0
MLL4	200	0	0
WDR5	200	762	249
PRO2730	200	0	0
WHSC1	200	810	34
WHSC1L1	200	659	18
WNT5A	200	689	0
GAS41	200	0	0
YY1	200	925	219
ZBED3	200	632	56
ZBTB33	200	735	10
ZBTB38	200	785	0
ZBTB4	200	721	4
ZBTB7	200	0	0
ZMYND11	200	821	23
PRKCBP1	200	0	0
ZNF238	200	0	0
CBX2	200	785	0
Cecr2	200	654	0
DNMT3A	200	918	24
FOXC2	200	762	4
GLI1	200	813	0
HMGB4	200	724	0
RPA3	200	547	108
SETD1B	200	803	44
TAF3	200	811	191
KDM4B	200	702	18
'''