#!/usr/bin/env python

from Bio.Blast import NCBIWWW, NCBIXML

#testquery = "AGAGAAATAAAATCCTTTATAGACAAGCAAATGCTGAGAGATTTTGTCACCACCAGGCCTGCCCTAAAAGAGCTCCTGAATGAAGCACTAAACATGGAAAGAAACAACTGGTACCAGCCATTGCAAAAACATGCCAAATTGTAAAGACTATCGATGCTATGAAGAAACTGCATCAATTAACAGGCAAAATAACCAGCAAACATCATAATGACAGGATCAAATTCACACACAACAATATTAAACTTAAATGCAAATGGGCTAAATGCCCCAATTAAAAGACTGGCAAATTGGATAAAGAGTCCTATCAGTGTGCTGTATTCAGGAGACCCATCTCACATGCAAAGACACACATAGGCTCAAAATAAAGGGATGGAGGGATATTTACCAAGCAAATGGAAAGCAAAAAAAAGGCAGGGGTTGCAATCCTAGTCTCTGATAAAACAGACTTTAAACCAACAAAGATCAAAAAAGACAAAGCCATTATATAAAGGTAAAGGGATCAATGCAACAAGAAGAGCTAACTATCCCAAATATGTATGCACCCAATACAGGAGCACCCAGATTTGTAAAGCAAGTTATTAAAGACCTACAAAGTGACTTGGACTCCTACAAAATAATAGTGGGAGACTTTAACACCCCACTGTCAATACTACACAGATCAACGAGACAGAAAATTAACAAGAATATTCAGAACTTGAACTCAGCTCTGGACCAAGTGGACCTAATAGACATCTACCGAACTCTCCACCCCACATCAACAGAATACACATTCTTCTCAGCACCACATCACACTTATTCCAAAATTGACCACATAATTGGAAGTAAAACACTCCGCAGCAAATGCAAAAGAATGGAAATCATAACAAAGTCTCTCAGACCATAGTGCAATCAAATTAGAACTCAGGATTAAGAAACTCACTCGAAACCACACAACTACATAGAAACTGAACAACCTGCTCCTGAATGACTACTGGGTAAATAACAAAATTAAGGCAGAAATAAATAAGTTCTTTGAAACCAATGAGAACAAAGACACAATGTACCAGAATCTCTGGGACACAGCTAAAGCAGTGTTTAAGGGAAATTTTACAGCACTAAATGCCCACAGAAGAAAGCAGGAAAGATCTAAAATCAACACCCTAACACCACAATTGAAAAAACTAGAGAAGCAGGAGCAAACAAATTCAAAAGCTAGCAGAAGATAAGAAACAACTAAGATCAGAGCAGAACTGAAGGAGATAAAGACACAAAAAAGCCCTTCAAAAACATCAATGAATCCAGGAGCTTGTTTTTTTGAAAAGATCAACAAAATAGATAGACCGCTAGCCAAACTAAAAAGAAGAAAAGAGAGAAGAATCAAATAGACACAATAAAAAAATGATAAAGGGGATATCACCACCAATCCCACAGAAATACAAACTACCATCAGAGAATACCATAAACACCTCTACACAAATAAACTAGAAAATCCAGAAGAAATGGATAAATTCCTGGACACATACACCCTCCTAAGACTAAACCAGGAGAAAGCTGAATCCGTGAATAGACCCATAGCAAGTTCTGAAACTGAGGCAGTAATAGCTTACCAACCAAAAAAAAAGCCCAGGACCAGACGGATTCATAGCCTAATTCTACCATCAGAGGTACACGGAGGAGATGGTACCATTCCTTCTGAAACTATTCCAAACAATAGAAAAAGAGGGACTCCTCCCTAACTCATTTTATGAGGCCAGCATCATCCCGATACCAAAACCTGGCAGAGACACAACAAAAAAAGAAAATTTCAGGCCAATATCCCTGATGAACATCAATGTGAAAATCCTCAATAAAATACTGGCAAACCAAATCCAGCAGCACATCAAAAAGCTTATCCACCATAATCAAGTTGGCTTCATCCCTGGAATGCAAGGCTGGTTGAACATATGCAAATTAATAAATGTAATCCATCACATAAACATAACTAATGACACAAAACACATGATTATCTCAATAGATGCAGAAAAGGCCTTTGACAAAATTCAACACTCCTTCATGCTAAAAGCTCTCTATAAACTAGGTATTCATGGAATGTATCTCAAAATAATAAGAGCTATTTATGACAAACCCACAGACAATATCATACTGAATGGGCAAAACCTGGAAGGATTCCCTTTGAAAACTGGCACACGACAAGGATGCCCTCTCTCACCACACATATTCAACATAGTATTGGAAGTTCTGGCCAGGGCAATTAGGCAGGAGAAGGAAATAAAGGGTATTCAGTTAGGAAAAGAGGAAATCAAATTGTCTCTGTTTGCACATGACATGATTGTATATTTGGAAAACCCCAGAGTCTCAGCCCCAAATTACCTTAAGCTGATAAGCAATTACAGCAAAGTCTCAGGATATAAAATCAATGTGCAAAAATCACAAGCATTCCTATACACCAATAATAGATGAACAGAGAGCCAAATCATCAGTGAACTCCCATTCATGATTGGTACAAAGAGAATAAAATACACAGGAATACAAATTACAAGGGATAGGAAGGACCTCTTCAAAGAGAACTACAAACCACTGCTCAAGAAAATAGGAGAGCACACAAACAAATGGAAAACCATTCCATGCTCATGGATAGGAAGAATCAATACCATGAAAATGGCCATACTGCCCAAAGTAATTTATAGATTCAATGCTATCCCCATCAAACTGCCACTGACTTTCTTCACAGAATTAGAAAAAACTACTTTAAATTTCATATGGAACCAAAAAAGAGCCCATATAGCCAAGACAATCCTAAGCAAAAAAAACAAAAGCTGGAGGTATCACACTTCCTGACTTCAAACTATACTACAAGGCTACAGTAACCAAGACAGCATGGTACTGGTACCAAAACAGACATAAAGACCAATGGAACAGAACAGAGGCCTCAGAAATAACACCACACATCTACAACCATCTGATCTTTGACAAATCTGACAAGAACAAGCAATGGGGAAAGGATTCCCTATTTAATAAATG"
#testquery = "GTGACCTCAGGCCAGAGTGGAGTATGAGCGGAAAGGATGAATCCTGTGGC"
testquery = "GTGACCTCAGGCCAGAGTGGAGTATGAGCGGAAAGGATGAATCCTGTGGCTTCTGCCCTACCCCACGGCCAAGGCTGTGCTACTGATGTGATGACCCACCATCCTGAGCAGTTCAAACCTGCAGGTGTCAGCTGTAAGCTGCAAAAGTGAGCTCTGTCTCCAAATGACCCCTAGTTGTGAGCTGTTGGTGTAACAGTTACAGGCCATCAGAGGCAGTAGCCTAGGGAAGACCTTGGCCACACGACCCCATTCTCAAATCTGGGTCTCCCCCTTGGCGGTGCTGTCAGCGCACAGACCCATGCGCACCTCCCCCAGATCCTTTACCCTGACAATATGTATTATATTTTAATGTATATGTGAAGATATTGAAAATAATTTGTTTTTCCTGGTTTTTGTTCTGTTTTTGTTTGCTGTTAGCATCTATGTGCTGGAATCAAGGAAAGACTTTGTGAGGATAGTATAAATTCTCCTGCAAGGTTGGATTTGTTATCATGTAAATATCCCAACGCAGGCTGCCTTGTGGTTTGGCCGCCTTGTGCTATGTTGATAAGATTGATTTACTGCTTCAGATCACTTTACTTTATCCAATTTTTACTGAACTTTTTATGTAAAAAATAAAATCAATTAAAGAACTTGGAATGTGTGCTCCCTCAAAATTAATCAGGTTTGTTTGTGTTGATGTGAAAGGATGTAGTGGTCCTGGTGTGTGGAGGCTGAGATTAACCTTTCTACTGCAGTTCATTATAAGCTTGGTTCTTGAGCCTGAGCTTACTTGAGCTTACAGTTTAGTCATTCCAGACCAGAGGATGTCTGTCCTGAGACCTCATTGCCACTGGCTTGTTTTAATTTGGCTAGTGGGTCAATCAAGAGAAAATGTCTTCACTCTTGGCTGGAGAATGTCACTGGACCATTTTGCCTTCAGACTTCACTTCTCCCACCCCACAGGAGTGTTCCTTCAGTGTGTGGGGCCTAGCTTCTCACTTTACTTTACACTGGGCCTAGACAAGAGAGAAAGCAGCAAAGGACAGGACAGCTGTGGCAGGGGTGCAGGCACCGGCATATGGTAAGAGTGTCTGTGTATTCTAGATGCAGGCTCGGCAGTGGCCTCTTTGGTGATGAGTTTTCAACAGAGAGAAGTTCATGCTAGATTGGGGCCCATGTGTTTCTCAGGAATGTGATTCTGCTTTGCAAAACGAGGCTTGGTTGAGGCCTGACAGAAATTAGAGCGCCTTTTGCCTGTATATTAAGCATTTCAGAGATTGGGGTATGTCCTTACAACTCTTAGAGAAATTGGCACTGTGGGTAAGACTTAAGACCAAGCAAGCTGGGCTGGAGAGATGGCTCAGCGGTTAAGAGCACTGACTGTTCTTCCAGAGGTCCTGAGTTCAGTTCCCAGCAACCACATGGTGGCTCACAACCATCTGTAATGGGATCTGATGCCCTCTCCTGGTGTGTGTCTGAAGACAGCTACAGTGTACATGTACATAAAAAAGTAAAATAAAAGACCAAGCAAACTTCAGTCACTCATTTACAATTCTATATTAGAGGGCAGAGATTCTTTATGGTCATGCATGCTGTGTAGCAAATTTTCCATCACTACCTCTGGGGGCTTGGCTACAAGTGTGTAGATGATCAAGCACCTTAAATAAAACGGCATAGTTCATACCTGTAGTCTACCCGCATGGATCCTGGCTATCTCTGGATTACTTCCAGCCTAATACCATGCCAGTGCCATACAAGGCTAGTTGATCAGCAATACATGAATGTGGACCCTAGACACTATGGACTAATAATCTAGCCTTCTTCACTTTGTAACTTAAATGCACGTTGTTGTAGTAAGTGGACCATAATTCACTCGACCCTTGACAATTTCTAGTTGTGTCTGGTACAGTGAGTTTTCGTGTTTTTCCAAGGGAATGTCAGAGTGGTGACATAGGCGTCAAGTTTTAGAAGAGATTTTGAGACGTTTTACTTTTCTTGTTCCCCGCCACAAATGTTTTTTACCTTCCCTCCATATGCCTTCCTGTTGGCATGACCTAAGTAGGGACAGTGTGTGCCAGTCTGTTCATGGAAAATGTTATGCTCACCTGCTGACGCAGTCCTTGGTGGCCCAGCAGCTGACTGCTCAAGTGGAGTGTGGGCTTCCCAGTGGGCTGATCTGAGACTTTGCTGGTTTTTTTCTCTTCATCTATGCCTCATACAAAGTAGCGAGCGACTCCTATGAGCATCTCAGTGCAGTGAGGGAGCAGGGTCTACTTGGCCTCCACTTCACCATGATCTTACCTCAGGTCTTCTCAGTGAGTCTGGATGAACTAAAGCCCTTTCATCCATTGCACTGGTCCTTCCTAGAAGGCAGAGCGGGACCCAGCTACCTGCGCCCCCTTGAGGATGGGTGTGTGTGTGGAAGTACAGGTGGCTTGGCTCGACGCCCTGTCATGAACAGCCTGTTTGCCCACTTGTGTTCAAATCACATGCACAGCTGTGGAAGCCTGGGTGGAATTCCTCAGCCTGGGTGGCAGTCTGCTCTTTTTATTTTTTTGTAGCTCTGGAGATTGAACCTAGGACCTTGCGTGTGCTAGACAAGTGCCCTGCCAGTATGCCCAGCCAGAATCCCAGTGTTGGTTTTTTTTTTGTTGTTTTTTTTTTTGGATTTTTCGAGACAGGGTTTCTCTGTGTAGCCCTGGCTGTCCTGGAACTCACTCTGTAGACCAGGCTGACATAGAACTCAGAAATCCTCCTGCCTCTGCCTCCCAAGTGCTGGGATTAAAGGCACGCGCCACCACTGCCCGGCTGAGTCCCAGTGTTGAAACGTCATCTTTTTCTTGTCTAAAGATGACCTAACGTCTTCAACAACTAGCTCACCACAACTACCTTGCATCTTCCCTGTCACAGCACAAGTCACGCAAAGGGTCCTTGGGTGCACCATGGGAACCTTAGGGGTAGAGGACTTACTACATATGCCTCCACTAAGCAAAGACTGGAGTTCAGGAGGAGACATGACTTGTTAATGTCATCCAAACACTGAAGGGCAGGAGGGTGAGCTCCAGCCTGGCCCTCCACAGCCCATGTACAGAAGCGCCCCCACCTCCTTCCCAAGTCCTTGTCTGGGTCTCTTTCACAGCTACCCAACTGTCTTACAGGTCCAAGGAGCCAAGTAGGTTAGAACAAAACTCCAAAGGTGCCTTTAATATGTGATTCTTAAAAAGAAATAGAAAAAATAACAAGCACATAAAGGGGCAGAACGAGAATCTGTGGGCAAAGCCATGCCCACTCTCTTACCCACCCCCCCATGTCCCTCGCTTCTATCTTGGAGAGGATGGAGAAGGAACATGAAGTGGCCGGATCTTTTGTGTTCTGCTGCCACAACAGCAAGCTGAAGCCAGAGAAGTACTAGGAAGCCCATGAAAGACATGAGGCCAGGGCAGGCAGCCCTGGGAGGCGGCACTCACACCACCGAGGAGCTCTCAGCTGGCGAGCTCAAAACCTGGACCACATCTTCTCGGCCTATGGCAGCCAGAGCATCCTCCAGCACTCTGAGGGTAGCTCTATTGCCTTCTTGGGCAGCCCAGTTCCTTAGCAGGGTATAGGCTGGCATTTGGTCACAGGCCATGGTTTCCACAGCCTCAGCTTGGTAGCCGAGGTGGCCTGCCAGCTCCTGCCAGCCCTTGGCTGGCTCACCCATCATCAGGAGCCGCTGGACTTCCTCCTGCTGCTGCTGTGGAATATGCAGGTAAAGCTGGCAGCCAAGGTCCGGGTGTGGTCCTGGGTGGGGGTGGGGGTGGGGGTGAAGAGAGAAGTGTTAGTGGGTAGGGGAGGCACTAGTTAAATACAAAGGACTACAGACAGACTAGGAAACGTGCTCACCCTGGCTGGGAATACAGGGCTCCAGACTAGGAGGAGAGTCCACGAAGACGTTGCTGTCACCACGCCTCTGGTCCCTGTCAGGGTCCCCTAGCTCTACAGTCCGAGCTTTAGCCAACTGTTGCCTTTGCTTATGTGAGCGCCAGCTGTAGGGGGCAGAGGGCACTAAGACAAGGAACTGCCTCAGAGTCCAGGCATGGAGGGGATGCCACAGGACAGGACCCAGACCACCTACCATTTGAAGGCCACATAGGCCAGCAGACCAAGGATCACTGTAGCTAGGAGAGCACAGTAGACAGGAATGATGTTGCTCGAGGCCCCTGGAGGCTCAGGGGGAAATAGGGAGGAGGTATTGGGGGCTAGGGCTCCCCCAGCTCCTACCCACATTCCTTCCCTGTCCCCGTCCTGCCCCTGCAGGGCTGTATCTGTGAAGACAGACAGTGGTCAAGATAGGGAGCCACGGCAGCCTCACCTAGGTAGACCATCTTGGCAGAACTTTCCAAATACATTAGAGTTTACCATGTGTTAAAGGACTACATGGCTGGCCCTGGAGCGGCAAGAATGGCTCAGCAGACAGACACATGCCACCAAGTATGACAACCTGAGTTTGATCCCCCAGGATCCCTGAACCACACGTGCCTGCTAAGTGGTTACTGGGGCTTGTACCGCCTCAGGACAGGAGTTCTGTTCCCAACACCACATTGGATGGATCACAGCCACCTTTAACTCAATCTCCTGGGGGGGTTGATGCCCTCTTACACCCTCTGTGGGCACTCTCACACACAGACGTGCACATAGGTACACGTAAATGGCCCTTTGCTTGCCATTGTGGACAGTCACTCCCAGATGTGCCTTGTCATCTTCCGGAAGCATCCAAACGTCTTGCTATTGCATCTTCTCCTAAACGCACAGCAGGATCTCCTCTGGAAGCCTTCCTTGACCTTTCTCTTTTCACCCTGGTTGCACCACCTCTGCTTACCACAGCACAAGATTGGTCGGCTTCCAGGGTAGACTGTGAGAGCACACTGATGTGTGCTGGTGTCATGGGATCATAAAAATAAAACTTAACTGGAAGTAAATACTGGTGCTCTCTCACTTCTGCCTTAAGTCCAATGACTGACTAGTCCTTGTACCCAGTGTAGACAGGGTTCAAGGGTCAGGGACTAAAGAGCCCGTGAATGGACTTGTACACGACCCACTCTACCTCCCAATCTGCCCGCTACCTAGGATCTGGGACAAGGAATGCCTACCTGAATAGACCACACCTTTGCTGACGTTATAAAGCATGGTGCTGCCAGGCGCTGCCTGCTGGGCTGTTTTTTGGTGAAGGGGAGTTGTGTAGAGAACTGAGTTGACGGAGCTTGGAGCCTGCTTCTCTTGAATCTCAGAAGGAGGAACTCTGCAGAAATATGAAGAAATCCTCAGATCTGCTGTCAGGAGTCCCTGGGGGCAGCGTGTGTGTCCATCCTGATTCACACCAGGGCTGGAACAGTTTCTCCTGTGTCAAATAGGTGGAGGTAACAACTGGCTCCTGCTAGCCAAAGCTGGTGGCATGGGGTACAGCTCAGGATAGAAATCACCCGATCTCAAAGACCTTCCCAAGTACCTGGGCTGAGTCTGGGGATGTTAAAAGGAGGGTAAAGATACATGGACTGTGACCCTATCTCAGGCTGAAACATCCCTAGGAACTGGTGATCATACACATCTGCCAAAACCCAGCATCCCAAGGTCCCCAAGGCAAGCCCGCTTACACTGCCTAATGCTCCCTCTGTCCCCTCCAGGGCCAGTGGCCAGCCCTTTCCTGGGCAGGGACTAAGTGAACTGATACCTTAATGGTTCAGCAAACTCATAGACCATACAGATCTCAGAGGGCCTGAAATGGAAGAACAGGGCCAACTCAGACCAAGGACCCACCTGGACCCTAGAGTACTAAATCTGCTGAGACCACTCCCTGCAGTCTACGGAGGAGGAGAGGCTCCAGATCTGAAGGAGGAGAGAGATCTGGCTTGGATAAGTAAGAGATTAAAAGAGGCCCTTCAAGTCCCCAACGGCTACTGCTGCATAGCCAATGGCTCTAACACGTGGTGTGTCTATAGTAGGGCTATCAGCAGTTCGGTGCTGTAGTCAGGTAAACCTCTGATGTGGGTGGCCCCTTTATGGACTTTGTATCTTTGTGTCGCCACATTGGGAGTTGGGGGCTTCTGGGATCCTTGGTGGGTGGGCCTGTAAACCAGTAGCAGCAGACAGGCCTTGGAATCTGCCCCACCCATCCTGAGCAGCCGGAGTGGAACTTCTTCAGGGCTCCCCACCCATCTCCAAGCCCAAAATGGGAAGAAACAATTCAACAGCCCCTGCAGGCCCATACACACCCCAACACAGACGCTGGTACCCACAGGATCAGAGCACTAAAGGCGGGAGACAGAGAAAGTTCTGGCCCCTTCCACCTAGCAAGAGCCCGGCTAGTCATTCCCTCCTAACCTTCTGCGGCCACCCCTCCGAGGGTGCCAGGATCCACTCAGCTAGGAAGACGACGGGAGTCCCTGGAGAGGGCAGGTTCCGGTCTGCCCAAGAGTGAGCCAAGGCAAGGGGCGGGCCAGTGGGGGGGTGGTGTTGAAGAGGGGAGCAGGACAATGAAGAGGCGGGGCCGAGCTCGAGGGCGCGGTCCCGCCCCCGCCCCACGCCGGAGCACGCAGAAGCACTCGGAGTTCACAGAAGCCGACACCAGCGTGCCTGGCAGAGCAGGCCACTGGCATGCAAATGCCATGCAATGGACCGCGAGAGCTGAGAACCAGGAGTCAGGAAACGTCTGGCAAAGCCAGAGGCGCCTCCGCTGGCTACACCGAGGCCAGCCTGGCCAGGAAGAAGCATGCCAGGCCAGACAGGGTAACAGAGGCTAAGACTGGGGGCCACAGGAGGCCAAGGACGGCGGCACATGTGTACTCAAGAAACCGAAAGATTACAAAACTAGGCCACGTTTATTGCTGAGAATGGGCAGCGATAGTCACCTTTGAGGATTAAGGCCACAGGTGGTCTTTGTGCTTTCACTGGGACGTGGGATTTGAAAGTAGGGATTCCCTCCCACCCCAGAT"

tmpoutput = "ncbiblast.xml"

E_VALUE_THRESH = 1e-50
hls = 5

def runBlastQuery(seq, outfile):
	print "sending query..."
#	result_handle = NCBIWWW.qblast("blastn", "ref_contig", seq, entrez_query="mouse[orgn]")
#	result_handle = NCBIWWW.qblast("blastn", "ecoli", seq)
#	result_handle = NCBIWWW.qblast("blastn", "chromosome", seq, entrez_query="mouse[orgn]")
	result_handle = NCBIWWW.qblast("blastn", "gpipe/10090/ref_contig", seq, hitlist_size=hls)
	with open(tmpoutput, "w") as fh:
		fh.write(result_handle.read())

def readBlastQuery(infile):
	print "reading query results..."
	with open(infile) as fh:
		blastrecords = NCBIXML.parse(fh)
		try:
			for record in blastrecords:
				for alignment in record.alignments:
					for hsp in alignment.hsps:
						print '****Alignment****'
						print 'sequence:', alignment.title
						print 'length:', hsp.align_length
						print 'e value:', hsp.expect
						print hsp.query
						print hsp.match
						print hsp.sbjct
						print hsp.gaps
		except ValueError:
			print "badly formed results!"
			return

if __name__ == "__main__":
	runBlastQuery(testquery, tmpoutput)
	readBlastQuery(tmpoutput)
